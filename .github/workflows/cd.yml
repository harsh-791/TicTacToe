name: CD Pipeline - Kubernetes Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline - DevSecOps"]
    types: [completed]
  workflow_dispatch:

env:
  IMAGE_NAME: tictactoe-app
  K8S_NAMESPACE: tictactoe

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4

      # Setup Kubernetes cluster
      - uses: helm/kind-action@v1.10.0
        with:
          cluster_name: tictactoe-cluster
      - uses: azure/setup-kubectl@v3
      - run: kubectl cluster-info

      # Deploy application
      - name: Create namespace
        run: kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy application
        run: |
          IMAGE="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest"
          sed "s|IMAGE_PLACEHOLDER|${IMAGE}|g" k8s/deployment.yaml | kubectl apply -f - -n ${{ env.K8S_NAMESPACE }}
          kubectl apply -f k8s/service.yaml -n ${{ env.K8S_NAMESPACE }}

      # Verify deployment
      - name: Wait for rollout
        run: kubectl rollout status deployment/tictactoe-deployment -n ${{ env.K8S_NAMESPACE }} --timeout=5m

      - name: Check deployment status
        run: |
          kubectl get deployments -n ${{ env.K8S_NAMESPACE }}
          kubectl get pods -n ${{ env.K8S_NAMESPACE }}
          kubectl get services -n ${{ env.K8S_NAMESPACE }}

      # Runtime validation
      - name: Run smoke test in pod
        run: |
          POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.IMAGE_NAME }} -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${{ env.K8S_NAMESPACE }} ${POD_NAME} -- java -jar app.jar --smoke-test

      - name: Verify pod health
        run: |
          POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.IMAGE_NAME }} -o jsonpath='{.items[0].metadata.name}')
          POD_STATUS=$(kubectl get pod -n ${{ env.K8S_NAMESPACE }} ${POD_NAME} -o jsonpath='{.status.phase}')
          if [ "$POD_STATUS" != "Running" ]; then
            echo "❌ Pod not running: $POD_STATUS"
            exit 1
          fi
          echo "✅ Pod is healthy"
