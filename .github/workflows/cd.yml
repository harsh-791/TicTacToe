name: CD Pipeline - Kubernetes Deployment

on:
  workflow_run:
    workflows: ["CI Pipeline - DevSecOps"]
    types: [completed]
  workflow_dispatch:

env:
  IMAGE_NAME: tictactoe-app
  K8S_NAMESPACE: tictactoe

jobs:
  deploy:
    name: Deploy to Kubernetes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    steps:
      - uses: actions/checkout@v4

      # Setup Kubernetes cluster
      - uses: helm/kind-action@v1.10.0
        with:
          cluster_name: tictactoe-cluster
      - uses: azure/setup-kubectl@v3
      - run: kubectl cluster-info

      # Build and load Docker image into kind cluster
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: ${{ env.IMAGE_NAME }}:latest
          load: true
      - name: Load Docker image into kind
        run: |
          kind load docker-image ${{ env.IMAGE_NAME }}:latest --name tictactoe-cluster
          echo "✅ Docker image loaded into kind cluster"

      # Deploy application
      - name: Create namespace
        run: kubectl create namespace ${{ env.K8S_NAMESPACE }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy application
        run: |
          IMAGE="${{ env.IMAGE_NAME }}:latest"
          sed "s|IMAGE_PLACEHOLDER|${IMAGE}|g" k8s/deployment.yaml | kubectl apply -f - -n ${{ env.K8S_NAMESPACE }}
          kubectl apply -f k8s/service.yaml -n ${{ env.K8S_NAMESPACE }}

      # Debug pods before waiting for rollout
      - name: Debug pods (initial state)
        run: |
          echo "=== Waiting 5 seconds for pods to start ==="
          sleep 5
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide || true
          echo ""
          echo "=== Pod Events ==="
          kubectl get events -n ${{ env.K8S_NAMESPACE }} --sort-by='.lastTimestamp' | tail -20 || true
          echo ""
          echo "=== Pod Details (if pods exist) ==="
          PODS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
          if [ -n "$PODS" ]; then
            for pod in $PODS; do
              echo "--- Describe pod: $pod ---"
              kubectl describe pod -n ${{ env.K8S_NAMESPACE }} $pod || true
              echo ""
              echo "--- Logs for pod: $pod ---"
              kubectl logs -n ${{ env.K8S_NAMESPACE }} $pod --tail=50 || true
              echo ""
            done
          fi

      # Verify deployment
      - name: Wait for rollout
        run: kubectl rollout status deployment/tictactoe-deployment -n ${{ env.K8S_NAMESPACE }} --timeout=5m

      - name: Check deployment status
        run: |
          echo "=== Deployment Status ==="
          kubectl get deployments -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Pod Status ==="
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o wide
          echo ""
          echo "=== Pod Events ==="
          kubectl get events -n ${{ env.K8S_NAMESPACE }} --sort-by='.lastTimestamp' | tail -20
          echo ""
          echo "=== Service Status ==="
          kubectl get services -n ${{ env.K8S_NAMESPACE }}
          echo ""
          echo "=== Pod Logs (if any pods exist) ==="
          PODS=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -o jsonpath='{.items[*].metadata.name}')
          if [ -n "$PODS" ]; then
            for pod in $PODS; do
              echo "--- Logs for $pod ---"
              kubectl logs -n ${{ env.K8S_NAMESPACE }} $pod --tail=50 || true
            done
          fi

      # Runtime validation
      - name: Run smoke test in pod
        run: |
          POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.IMAGE_NAME }} -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n ${{ env.K8S_NAMESPACE }} ${POD_NAME} -- java -jar app.jar --smoke-test

      - name: Verify pod health
        run: |
          POD_NAME=$(kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.IMAGE_NAME }} -o jsonpath='{.items[0].metadata.name}')
          POD_STATUS=$(kubectl get pod -n ${{ env.K8S_NAMESPACE }} ${POD_NAME} -o jsonpath='{.status.phase}')
          if [ "$POD_STATUS" != "Running" ]; then
            echo "❌ Pod not running: $POD_STATUS"
            exit 1
          fi
          echo "✅ Pod is healthy"
